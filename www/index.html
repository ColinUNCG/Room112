<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width; initial-scale=1.0; user-scalable=0;">
    <title>Room 112</title>
    <script type="text/javascript" charset="utf-8" src="js/phonegap-1.3.0.js"></script>
    <script src="js/jquery-1.7.1.min.js"></script>
    <script src="js/lawnchair-0.6.1.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/normal.css">
    <link rel="stylesheet" type="text/css" href="css/retina.css" media="only screen and (-webkit-min-device-pixel-ratio: 2)">
</head>


<body>
<div id="stage">
    <div id="card">
        <div id="top">
            <!-- messages for map -->
        </div>
        <div id="bottom">
            <input type="text" type="text" name="room" id="room" class="container"/>
            <input type="text" name="date" id="date" class="container"/>
            <input type="text" name="floor" id="floor" class="container"/>
            <button id="action" class="dissabled-button">Check In</button>
        </div>
    </div>
    <div id="pocket"/>
</div>

<script>
    //State Constants
    const ENTER_ROOM = "enter-room";
    const CHECK_IN = "check-in";
    const CHECK_OUT = "check-out";
    const SAVE = "save";

    // Application state
    var mode = ENTER_ROOM;
    var hotelData;
    var currentRoomData;
    var cacheMapURL;
    /**
     * Init fucntion for app which adds event listeners, updates the display, and animates in the card
     */
    function onDeviceReady() {

        // First test to see if we have hotelData, if not get a reference to it
        getHotelData();

        if (currentRoomData == null) {
            mode = ENTER_ROOM;
            $("#top").css("background-image", "url('images/map-add-location.png')");
            var currentTime = new Date()
            var month = currentTime.getMonth() + 1
            var day = currentTime.getDate()
            var year = currentTime.getFullYear();
            var currentDate = month + "/" + day + "/" + year;
            $("#date").attr("placeholder", currentDate).val(currentDate);
        }
        else {
            console.log("Has Data");
            $("#date").attr("placeholder", currentRoomData.date).val(currentRoomData.date);
            $("#room").val(currentRoomData.room);
            $("#floor").val(currentRoomData.floor);
            $("#date").val(currentRoomData.date);
            cacheMapURL = currentRoomData.map;
            mode = CHECK_OUT;
            if(cacheMapURL)
                $("#top").css("background-image", "url('"+cacheMapURL+"')");
            else
                $("#top").css("background-image", "url('images/map-add-location.png')");
        }

        // Add event listeners for fields and buttons
        addInputListeners();

        // This sets the correct state for the display
        updateDisplay();

        //Show card
        $('#card').delay(1000).animate({top:12}, 500);
        $('#top').click(loadGPS);
    }
    function loadGPS()
    {
        navigator.geolocation.getCurrentPosition(showMap, showMapError);
    }
    function addInputListeners() {
        $("input").focusout(function () {
            invalidate(this.id);
            updateDisplay();
        });

        $("#action").click(formAction);
    }

    //TODO need invalidation for map?
    function invalidate(value) {
        if (currentRoomData) {
            var fieldID = "#" + value;

            //Test state
            console.log("Invalidate", value, $(fieldID).val(), currentRoomData[value]);
            if ($(fieldID).val() != currentRoomData[value]) {
                mode = SAVE
            }
            else
                mode = CHECK_OUT;
        }
        else {
            if (!$('#room').val())
                mode = ENTER_ROOM;
            else
                mode = CHECK_IN;
        }
    }

    function updateDisplay() {
        $("#action").attr('class', mode).text(mode.replace("-", " "));
    }

    function getHotelData() {

        // Get hotel save data object from Lawnchair
        if (!hotelData) {
            hotelData = new Lawnchair({name:'hoteldata'}, function (e) {
                console.log('Storage Open', this);
            });
        }

        // Get current room data from the hotelData object
        hotelData.get("room", function (obj) {
            currentRoomData = (obj) ? obj.value : null;
        });
    }

    function formAction() {
        // Return if room data is empty
        if (mode == ENTER_ROOM)
            return;

        switch (mode) {
            case CHECK_IN:
                checkIn();
                break;
            case CHECK_OUT:
                checkout();
                break;
            case SAVE:
                saveRoomData();
                mode = CHECK_OUT;
                break;
        }

        updateDisplay();
    }

    function checkIn() {
        saveRoomData();
        mode = CHECK_OUT;
        updateDisplay();
    }

    function saveRoomData() {
        var newRoom = $("#room").val();



        var formData = {
            room:$("#room").val(),
            floor:$("#floor").val(),
            date:$("#date").val(),
            map: cacheMapURL
        }
        hotelData.save({key:"room", value:formData});
        hotelData.get("room", function (obj) {
                    currentRoomData = obj.value;
                }
        );

    }

    function checkout() {
        if (confirm('Are you sure you want to check out?')) {
            $('#card').animate({top:-900}, 250, resetCard);

        }
    }

    function resetCard() {
        console.log("reset card");
        hotelData.nuke();
        currentRoomData = null;
        cacheMapURL = null;
        $("#room").val("");
        $("#floor").val("");
        mode = ENTER_ROOM;
        $("#top").css("background-image", "url('images/map-add-location.png')");
        updateDisplay();
        $('#card').delay(500).animate({top:12}, 500);

    }

    function showMap(position) {
        // Show a map centered at position

        latitude = position.coords.latitude;
        longitude = position.coords.longitude;

        var coords = position.coords;
        var width = 296;
        var height = 85;
        // Call for static google maps data - make sure you use your own Google Maps API key!
        cacheMapURL = "http://maps.google.com/maps/api/staticmap?center=" + coords.latitude + "," + coords.longitude + "&zoom=13&size="+width+"x"+height+"&maptype=roadmap&key=MyGoogleMapsAPIKey&sensor=true";
        $("#top").css("background-image", "url('" + cacheMapURL + "')");
    }

    function showMapError(error) {
        //TODO make map unavailable with message
        $("#top").css("background-image", "url('images/map-error.png')");
    }
    //    if(device)
    //document.addEventListener("deviceready", onDeviceReady, false);
    //    else
    onDeviceReady();

</script>
</body>
</html>