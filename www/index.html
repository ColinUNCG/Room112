<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width; initial-scale=1.0; user-scalable=0;">
    <title>Room 112</title>

    <script type="text/javascript" charset="utf-8" src="js/phonegap-1.3.0.js"></script>
    <script src="js/jquery-1.7.1.min.js"></script>
    <script src="js/lawnchair-0.6.1.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/normal.css">
    <link rel="stylesheet" type="text/css" href="css/retina.css" media="only screen and (-webkit-min-device-pixel-ratio: 2)">
    <style type="text/css">
        <!--
        * {
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
            -webkit-text-size-adjust: none;
            -webkit-user-select: none;
        }
        -->
    </style>
</head>


<body>
<div id="stage">
    <div id="card">
        <div id="top">
            <div id="preview">

            </div>
            <!--div id="hotel-group">
                <div id="name-container">
                    <input type="text" name="name" id="name" class="container" value="" placeholder="Hotel"/>
                </div>
                <div id="address-container">
                    <input type="text" name="address" id="address" class="container" value="" placeholder="111 Street Name</br>City State 111111"/>
                </div>
            </div>-->
        </div>
        <div id="bottom">
            <div id="room-container">
                <div id="room-border" class="border-group">
                    <input type="number" type="text" name="room" id="room" class="container" value=""
                           placeholder="ROOM #"/>
                </div>
                <label for="room">Room Number</label>
            </div>
            <div id="misc-group">

                <div id="floor-container">
                    <div id="floor-border" class="border-group">
                        <input type="number" name="floor" id="floor" class="container" value="" placeholder="FLOOR #"/>
                    </div>
                    <label for="floor">Floor Number</label>
                </div>

                <div id="date-container">
                    <div id="date-border" class="border-group">
                        <input type="text" name="date" id="date" class="container"/>
                    </div>
                    <label for="date">Checkin Date</label>
                </div>
            </div>
            <div id="map-container">
                <img id="map"/>
            </div>
            <button id="action" class="dissabled-button">Check In</button>
        </div>
    </div>
</div>

<script>
    //State Constants
    const ENTER_ROOM = "enter-room";
    const CHECK_IN = "check-in";
    const CHECK_OUT = "check-out";
    const SAVE = "save";

    // Application state
    var mode = ENTER_ROOM;
    var hotelData;
    var currentRoomData;

    /**
     * Init fucntion for app which adds event listeners, updates the display, and animates in the card
     */
    function onDeviceReady()
    {
        console.log("Init");

        // First test to see if we have hotelData, if not get a reference to it
        getHotelData();

        if (currentRoomData == null) {
            $("#date-container").hide();
            mode = ENTER_ROOM;
            navigator.geolocation.getCurrentPosition(showMap, showMapError);
        }
        else
        {
            console.log("Has Data");
            $("#date").attr("placeholder", currentRoomData.date).val(currentRoomData.date);
            $("#room").val(currentRoomData.room);
            $("#floor").val(currentRoomData.floor);
            $("#date").val(currentRoomData.date);
            $("#date-container").show();
            mode = CHECK_OUT;
        }

        // Add event listeners for fields and buttons
        addInputListeners();

        // This sets the correct state for the display
        updateDisplay();

        //Show card
        $('#card').delay(1000).animate({top: 12}, 500);
    }

    function addInputListeners()
    {
        $("input").focusout(function () {
            invalidate(this.id);
            updateDisplay();
        });

        $("#action").click(formAction);
    }

    function invalidate(value)
    {
        if(currentRoomData)
        {
            var fieldID = "#"+value;

            //Test state
            console.log("Invalidate", value, $(fieldID).val(), currentRoomData[value]);
            if($(fieldID).val() != currentRoomData[value]){
                mode = SAVE}
            else
                mode = CHECK_OUT;
        }
        else
        {
            if(!$('#room').val())
                mode = ENTER_ROOM;
            else
                mode = CHECK_IN;
        }
    }

    function updateDisplay() {
        $("#action").attr('class', mode).text(mode.replace("-", " "));
    }

    function getHotelData() {

        // Get hotel save data object from Lawnchair
        if(!hotelData)
        {
            hotelData = new Lawnchair({name:'hoteldata'}, function (e) {
                console.log('Storage Open', this);
            });
        }

        // Get current room data from the hotelData object
        hotelData.get("room", function (obj) {
            currentRoomData = (obj) ? obj.value : null;
        });
    }

    function formAction() {

        // Return if room data is empty
        if(mode == ENTER_ROOM)
            return;

        switch (mode)
        {
            case CHECK_IN:
                checkIn();
                break;
            case CHECK_OUT:
                checkout();
                break;
            case SAVE:
                saveRoomData();
                mode = CHECK_OUT;
                break;
        }

        updateDisplay();
    }

    function checkIn() {
        saveRoomData();
        mode = CHECK_OUT;
        updateDisplay();
    }

    function saveRoomData()
    {
        var newRoom = $("#room").val();

        var currentTime = new Date()
        var month = currentTime.getMonth() + 1
        var day = currentTime.getDate()
        var year = currentTime.getFullYear();
        var currentDate = month + "/" + day + "/" + year;
        $("#date-container").attr("placeholder", currentDate).val(currentDate).show();

        var formData = {
            room:$("#room").val(),
            floor:$("#floor").val(),
            date:$("#date-container").val()
        }

        hotelData.save({key:"room", value:formData});
        hotelData.get("room", function (obj) {
                    currentRoomData = obj.value;
                }
        );

    }

    function checkout() {
        if(confirm('Are you sure you want to check out?'))
        {
            $('#card').animate({top: 900}, 250, resetCard);

        }
    }

    function resetCard()
    {
        console.log("reset card");
        hotelData.nuke();
        currentRoomData = null;
        $("#room").val("");
        $("#floor").val("");
        $("#date-container").hide();
        mode = ENTER_ROOM;
        updateDisplay();
        $('#card').delay(500).animate({top: 12}, 500);

    }

    //TODO need to save out the path to image/coordinates and only call this when needed
    // Get the current location
    //navigator.geolocation.getCurrentPosition(showMap, showMapError);
    function showMap(position) {
        // Show a map centered at position

        latitude = position.coords.latitude;
        longitude = position.coords.longitude;

        var coords = position.coords;
        // Call for static google maps data - make sure you use your own Google Maps API key!
        var url = "http://maps.google.com/maps/api/staticmap?center=" + coords.latitude + "," + coords.longitude + "&zoom=13&size=268x100&maptype=roadmap&key=MyGoogleMapsAPIKey&sensor=true";
        //document.getElementById('map').setAttribute('src',url);
        $("#map-container").css("background-image", "url('" + url + "')");
    }

    function showMapError(error) {
        //TODO make map unavailable with message
    }
//    if(device)
//        document.addEventListener("deviceready", onDeviceReady, false);
//    else
        onDeviceReady();
    

</script>

</body>
</html>